name: Performance Benchmarks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2:00 è¿è¡Œï¼ˆUTCï¼‰- ç›‘æŽ§æ€§èƒ½é€€åŒ–
    - cron: '0 2 * * *'

jobs:
  performance-benchmarks:
    name: API Performance Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio httpx

    - name: Generate encryption key and set up environment
      working-directory: ./backend
      run: |
        # Generate a proper Fernet encryption key
        ENCRYPTION_KEY=$(python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())")
        echo "Generated ENCRYPTION_KEY: ${ENCRYPTION_KEY}"

        # Set up environment variables
        echo "DATABASE_URL=postgresql://test_user:test_password@localhost:5432/test_db" > .env
        echo "REDIS_URL=redis://localhost:6379/0" >> .env
        echo "ENCRYPTION_KEY=${ENCRYPTION_KEY}" >> .env
        echo "ENVIRONMENT=test" >> .env

        # Display environment for debugging
        echo "=== Environment Variables ==="
        cat .env

    - name: Initialize test database
      working-directory: ./backend
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
      run: |
        python << 'EOF'
        import sys
        import logging
        logging.basicConfig(level=logging.INFO)

        try:
            from database import init_db
            init_db()
            print('Database initialized successfully')
        except Exception as e:
            print(f'Database initialization error: {e}', file=sys.stderr)
            sys.exit(1)
        EOF

    - name: Run performance benchmarks
      working-directory: ./backend
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
      run: |
        pytest tests/test_performance_benchmarks.py -v --tb=short

    - name: Run concurrent performance tests
      working-directory: ./backend
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
      run: |
        pytest tests/test_performance.py::test_concurrent_requests -v --tb=short

    - name: Generate performance report
      if: always()
      working-directory: ./backend
      run: |
        echo "## ðŸ“Š Performance Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### API Endpoints" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Portfolio endpoint: < 100ms" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Positions endpoint (paginated): < 200ms" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Strategies endpoint (paginated): < 200ms" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Concurrent requests (10): avg < 200ms, max < 500ms" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Database" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Connection pool utilization < 80%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*See test logs above for detailed results*"

    - name: Check for performance regression
      if: failure()
      working-directory: ./backend
      run: |
        echo "âš ï¸  Performance tests failed!"
        echo "Please review the logs above to identify the performance regression."
        exit 1

  frontend-performance:
    name: Frontend Bundle Size Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Build frontend
      run: npm run build

    - name: Check bundle sizes
      run: |
        echo "## ðŸ“¦ Frontend Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # åˆ†æž dist ç›®å½•
        if [ -d "dist" ]; then
          echo "### JavaScript Bundles" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æŸ¥æ‰¾æ‰€æœ‰ JS æ–‡ä»¶å¹¶æŽ’åº
          find dist -name "*.js" -type f -exec du -h {} \; | sort -rh | head -20 | while read size file; do
            filename=$(basename "$file")
            echo "- **$filename**: $size" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CSS Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          find dist -name "*.css" -type f -exec du -h {} \; | sort -rh | head -10 | while read size file; do
            filename=$(basename "$file")
            echo "- **$filename**: $size" >> $GITHUB_STEP_SUMMARY
          done

          # æ£€æŸ¥æ˜¯å¦æœ‰è¶…è¿‡ 500KB çš„æ–‡ä»¶
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸  Large Files (> 500KB)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          large_files=$(find dist -name "*.js" -type f -size +500k)
          if [ -n "$large_files" ]; then
            echo "$large_files" | while read file; do
              size=$(du -h "$file" | cut -f1)
              filename=$(basename "$file")
              echo "- **$filename**: $size âš ï¸" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Consider code splitting for large files." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No files larger than 500KB found!" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ Build failed - dist directory not found" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

  docker-build-performance:
    name: Docker Image Size Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build backend Docker image (optimized)
      run: |
        cd backend
        docker build -f Dockerfile.optimized -t tradeopenbb-backend:test .

    - name: Check backend image size
      run: |
        echo "## ðŸ³ Docker Image Size" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        backend_size=$(docker images tradeopenbb-backend:test --format "{{.Size}}")
        echo "### Backend Image" >> $GITHUB_STEP_SUMMARY
        echo "- **Current size**: $backend_size" >> $GITHUB_STEP_SUMMARY
        echo "- **Target size**: < 400MB" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # æå–æ•°å­—éƒ¨åˆ†è¿›è¡Œæ¯”è¾ƒ
        size_number=$(echo $backend_size | grep -oE '[0-9.]+')
        size_unit=$(echo $backend_size | grep -oE '[A-Z]+$')

        if [[ "$size_unit" == "GB" ]]; then
          # è½¬æ¢ä¸º MB
          size_mb=$(echo "$size_number * 1024" | bc)
          if (( $(echo "$size_mb > 400" | bc -l) )); then
            echo "âš ï¸  Warning: Image size exceeds 400MB target" >> $GITHUB_STEP_SUMMARY
          fi
        else
          if (( $(echo "$size_number > 400" | bc -l) )); then
            echo "âš ï¸  Warning: Image size exceeds 400MB target" >> $GITHUB_STEP_SUMMARY
          fi
        fi

    - name: Build frontend Docker image
      run: |
        docker build -t tradeopenbb-frontend:test .

    - name: Check frontend image size
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Frontend Image (nginx)" >> $GITHUB_STEP_SUMMARY

        frontend_size=$(docker images tradeopenbb-frontend:test --format "{{.Size}}")
        echo "- **Current size**: $frontend_size" >> $GITHUB_STEP_SUMMARY
        echo "- **Target size**: < 30MB" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # æå–æ•°å­—éƒ¨åˆ†è¿›è¡Œæ¯”è¾ƒ
        size_number=$(echo $frontend_size | grep -oE '[0-9.]+')
        size_unit=$(echo $frontend_size | grep -oE '[A-Z]+$')

        if [[ "$size_unit" == "GB" ]]; then
          # è½¬æ¢ä¸º MB
          size_mb=$(echo "$size_number * 1024" | bc)
          if (( $(echo "$size_mb > 30" | bc -l) )); then
            echo "âš ï¸  Warning: Image size exceeds 30MB target" >> $GITHUB_STEP_SUMMARY
          fi
        else
          if (( $(echo "$size_number > 30" | bc -l) )); then
            echo "âš ï¸  Warning: Image size exceeds 30MB target" >> $GITHUB_STEP_SUMMARY
          fi
        fi
