# 代码审查标准流程
# Code Review Standards - 严格遵循

## 🎯 核心原则

### ⚠️ 永不违反的原则

1. **实际 > 理论** - 解决代码中实际存在的问题，不是理论上的问题
2. **扫描 > 理解** - 先用工具扫描发现问题，再用人工理解验证
3. **数据驱动 > 文档驱动** - 从代码扫描数据出发，不是从最佳实践文档出发
4. **简单工具 > 复杂AI** - grep/ast 更可靠，AI 可能"创造"问题

---

## 📋 标准审查流程

### 阶段 1：系统扫描（必须执行）

```bash
# 1. 硬编码路径扫描
grep -r "c:\\\\Users\|/home/" . --include="*.py" --include="*.tsx" --include="*.ts"
grep -r "localhost" . --include="*.py" --include="*.tsx"
grep -r "127\\.0\\.0\\.1" . --include="*.py" --include="*.tsx"

# 2. 调试代码遗留扫描
grep -r "console\\.log\|console\\.debug\|debug\\.log\|print(" . --include="*.tsx" --include="*.ts"
grep -r "#region agent log\|#endregion" . --include="*.py" --include="*.tsx"

# 3. 类型安全扫描
grep -r "as any" . --include="*.tsx" --include="*.ts"
grep -r ": any" . --include="*.tsx" --include="*.ts"

# 4. 错误处理扫描
grep -r "except: pass\|except.*:" . --include="*.py"
grep -r "catch.*{}" . --include="*.tsx" --include="*.ts"
grep -r "\\.catch(()=>{})" . --include="*.tsx" --include="*.ts"

# 5. 常见代码问题
grep -r "parseInt([^,]*)" . --include="*.tsx" --include="*.ts"
grep -r "\\.join\|\\.map\|\\.forEach" . --include="*.tsx" | grep -v "?\\."
grep -r "\.toFixed\|\\.toLocaleString" . --include="*.tsx" --include="*.ts"

# 6. 重复代码
grep -r "import re" . --include="*.py" | wc -l
grep -r "allowed_origins\\s*=" . --include="*.py"

# 7. 性能问题
grep -r "useEffect" . --include="*.tsx" | grep -v "useEffect\\["
grep -r "React\\.memo" . --include="*.tsx"
```

### 阶段 2：问题验证（必须执行）

对每个扫描到的问题：
1. ✅ 用 Read 工具查看代码上下文
2. ✅ 确认问题确实存在
3. ✅ 评估影响范围
4. ✅ 确定严重程度（🔴严重/🟡中等/🟢轻微）

### 阶段 3：问题分类（必须执行）

```yaml
严重问题 (P0 - 立即修复):
  - 硬编码路径/配置
  - 安全漏洞
  - 数据库连接泄漏
  - 未处理的异常导致崩溃

中等问题 (P1 - 尽快修复):
  - 类型安全问题
  - 错误处理不完整
  - 性能问题
  - 代码重复

轻微问题 (P2 - 有时间修复):
  - 代码风格不一致
  - 注释缺失
  - 命名不够清晰
```

### 阶段 4：修复方案（必须执行）

**禁止的行为：**
- ❌ 生成大量文档而不修复实际问题
- ❌ 创建工具函数但不使用
- ❌ 提供"理论最佳实践"而非具体修复代码

**要求的行为：**
- ✅ 针对每个实际问题提供具体修复代码
- ✅ 修复前后对比
- ✅ 解释为什么这样修复
- ✅ 说明修复后的影响

### 阶段 5：验证修复（必须执行）

```bash
# 修复后验证
1. 重新运行扫描命令，确保问题已解决
2. 运行相关测试
3. 检查是否引入新问题
```

---

## 🔍 必检项目清单

### Python 后端
- [ ] 硬编码路径/配置
- [ ] 调试代码遗留 (print, debug.log)
- [ ] 空的 except 块
- [ ] 重复的 import 语句
- [ ] SQL 注入风险
- [ ] 敏感信息泄露
- [ ] 数据库连接未关闭
- [ ] 类型注解缺失
- [ ] 文档字符串缺失

### TypeScript/React 前端
- [ ] console.log/debug 调试代码
- [ ] as any 类型绕过
- [ ] 空值检查缺失 (?. 可选链)
- [ ] parseInt/parseFloat 缺少基数
- [ ] useEffect 依赖数组缺失
- [ ] 空的 catch 块
- [ ] 数组操作缺少空值检查
- [ ] 内联函数/对象导致重渲染
- [ ] key 属性使用 index

### 跨领域
- [ ] 重复代码（DRY 原则）
- [ ] 魔法数字/字符串
- [ ] 过长函数/方法（>50行）
- [ ] 过长参数列表（>5个参数）
- [ ] 嵌套层级过深（>4层）

---

## 📝 代码审查输出格式

### 必须包含的章节

```markdown
## 代码审查报告

### 1. 扫描摘要
- 扫描文件数: X
- 发现问题数: Y
  - 🔴 严重: A
  - 🟡 中等: B
  - 🟢 轻微: C

### 2. 问题列表（按严重程度排序）

#### 🔴 P0-严重问题

**问题 #1: [简短描述]**
- 位置: `文件:行号`
- 扫描命令: `grep -r "..." .`
- 问题代码:
  ```python/tsx
  [实际代码]
  ```
- 影响分析: [具体影响]
- 修复方案:
  ```python/tsx
  [修复后代码]
  ```
- 验证命令: [如何验证修复]

### 3. 修复统计
- 已修复: X
- 待修复: Y
- 需要确认: Z

### 4. 回归测试
- [ ] 重新扫描问题已解决
- [ ] 相关测试通过
- [ ] 未引入新问题
```

---

## ⚡ 快速参考

### 常用扫描命令

```bash
# 快速扫描命令集合（复制粘贴使用）
./scripts/quick-scan.sh
```

### 问题优先级决策树

```
问题会导致崩溃/安全漏洞?
├─ 是 → 🔴 P0 立即修复
└─ 否 → 问题会影响用户体验?
    ├─ 是 → 🟡 P1 尽快修复
    └─ 否 → 代码质量问题?
        ├─ 是 → 🟢 P2 有时间修复
        └─ 否 → 记录，暂不修复
```

---

## 🚫 禁止行为清单

在代码审查任务中，以下行为**严格禁止**：

1. ❌ 跳过系统扫描阶段
2. ❌ 只看文档/注释，不看实际代码
3. ❌ 用 AI 代理替代工具扫描
4. ❌ 生成理论最佳实践而非解决实际问题
5. ❌ 创建工具/文档但不使用它们修复问题
6. ❌ 声称"审查完成"但未验证所有问题
7. ❌ 提供模糊建议而非具体修复代码

---

## ✅ 成功标准

一次成功的代码审查必须满足：

- [x] 运行了所有必检扫描命令
- [x] 验证了每个发现的问题确实存在
- [x] 提供了具体的修复代码（不是建议）
- [x] 修复后重新扫描验证问题已解决
- [x] 运行测试确保未引入回归
- [x] 输出格式符合标准模板

---

## 📚 相关文档

- `./scripts/quick-scan.sh` - 快速扫描脚本
- `./scripts/detailed-scan.sh` - 详细扫描脚本
- `./checklists/REVIEW_CHECKLIST.md` - 审查检查清单
- `./examples/GOOD_REVIEW_EXAMPLE.md` - 好的审查示例

---

**最后更新**: 2026-01-19
**版本**: 1.0.0
**状态**: 已批准，严格遵循
