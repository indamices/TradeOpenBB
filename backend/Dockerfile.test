# Dockerfile for running tests (matches GitHub Actions environment)
FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements first for better caching
COPY requirements.txt .

# Install Python dependencies (same as GitHub Actions)
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Generate proper Fernet encryption key and set environment variables
# Fernet keys are 44 characters when base64-url-safe encoded (32 bytes decoded)
RUN python -c "from cryptography.fernet import Fernet; import os; key = Fernet.generate_key().decode(); print(f'Generated ENCRYPTION_KEY: {key}'); os.system(f'echo \"ENCRYPTION_KEY={key}\" >> /app/.env')"

# Set test environment variables (same as GitHub Actions)
ENV DATABASE_URL=sqlite:///./test.db
# Note: ENCRYPTION_KEY is set via the .env file generated above

# Initialize test database with proper error handling
RUN python -c "
import sys
import logging
logging.basicConfig(level=logging.INFO)

try:
    from database import init_db
    init_db()
    print('Database initialized successfully')
except Exception as e:
    print(f'Database initialization error: {e}', file=sys.stderr)
    # Don't fail the build - tests will handle missing tables
    sys.exit(0)
"

# Default command: run tests (same command as GitHub Actions)
CMD ["pytest", "tests/", "-v", "--tb=short", "--strict-markers"]
